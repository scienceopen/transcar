        subroutine geo2mag(latgeo,longeo,latmag,lonmag)

        implicit none

c    geographic coordinate conversion routine with the
c    dipole magnetic pole center
c    (lat = (90-8.56) deg, lon = 277.31 deg)

c    latgeo = latitude  geographic en degres decimal
c    longeo = longitude geographic en degres decimal
c    latmag = latitude  magnetic   en degres decimal
c    lonmag = longitude magnetic   en degres decimal

c    Baker and Wing, JGR, 94, 9139-9143, 1989
c    coordonnees dipolaires de Gustafsson
        real*8,intent(inout) :: latgeo,longeo,latmag,lonmag

        real*8 omega(3,3)
        real*8 dlongeo,dlatgeo,dlonmag,dlatmag
        real*8 coordgeo(3),coordmag(3)
        real*8 ca,cb,sa,sb
        integer i,j,k
        integer ndeg,mdeg
        parameter(ndeg=8,mdeg=8)

        real*8 x(0:ndeg),y(0:mdeg),xm,ym
        real*8 cx_geo2cgm(0:ndeg,0:mdeg),cy_geo2cgm(0:ndeg,0:mdeg)
        real*8 cx_cgm2geo(0:ndeg,0:mdeg),cy_cgm2geo(0:ndeg,0:mdeg)

        real*8,parameter :: lat=7.48d0,lon=171.01d0,lonref=261.36d0

        real*8,parameter :: deg2rad=0.01745329251994d0,
     &                      rad2deg=57.29577951308232d0

        data cx_geo2cgm/
     &   -1.7362173467106497d-02,8.1292551988288747d-02 ,
     &   6.3204708352179728d-02,-1.7562170253919429d-04 ,
     &   -4.4350685288477187d-02,-1.5704112770413614d-02 ,
     &   -3.7092102938096616d-03,-1.4487487783583219d-03 ,
     &   3.9970051240327820d-03,8.7732402248133678d-01 ,
     &   -4.2343532115698967d-03,1.3308443840685413d-01 ,
     &   -6.8934230380082395d-02,-1.4392750685825817d-01 ,
     &   1.5471481987377178d-01,-3.6460713647883836d-02 ,
     &   -1.5245199162117640d-02,1.0079909428385037d-01 ,
     &   3.2200018881531456d-02,-8.7774947167619410d-02 ,
     &   -6.6684753871807168d-02,-7.0789858326884669d-02 ,
     &   1.0261685998230519d-02,3.5817307315421232d-01 ,
     &   -2.4225923222240908d-01,2.7923950805785580d-02 ,
     &   3.0772032601566934d-01,1.5229264413199850d-01 ,
     &   -4.0329567908943709d-02,-1.1404090831548785d-01 ,
     &   2.6089635673207567d-01,4.7701521954013515d-01 ,
     &   3.3305656477523371d-02,-3.8501841545803472d-01 ,
     &   4.2308109569330554d-01,4.7322503758368839d-01 ,
     &   1.4249662010543673d-02,-8.0156414892626593d-02 ,
     &   1.5915492354352523d-02,1.4970487243851949d-01 ,
     &   -2.7021748058200501d-01,-4.3096078910576807d-01 ,
     &   5.8717807976017866d-01,7.8360786638950231d-01 ,
     &   -5.3117563224077458d-01,4.2974164210207277d-02 ,
     &   -4.1546984225831807d-02,-9.8449760620951565d-02 ,
     &   2.0686325250272830d-01,8.4771813068982738d-02 ,
     &   8.7884762447902176d-01,8.1332210224718438d-01 ,
     &   2.8626436128547539d-01,-2.7860060898588586d+00 ,
     &   3.2235492777239472d-03,-3.6307579595828088d-02 ,
     &   1.8273009292670395d-02,1.6747838655646774d-02 ,
     &   1.4471462317533224d-01,3.4963892550786113d-01 ,
     &   -2.4341438123519765d-01,1.2290825893269357d+00 ,
     &   -5.8629924087363179d+00,9.7682202196409662d-03 ,
     &   -2.1209999066854834d-02,-7.8293783130447991d-02 ,
     &   2.2384422316616792d-01,1.0566061126119166d+00 ,
     &   -8.9732826720864978d-01,-4.2903748839744367d+00 ,
     &   2.9070310302790290d+00,-2.4004189063216472d+00 ,
     &   -1.2776921818291598d-03,-1.4495096849479694d-02 ,
     &   1.5167465565582461d-02,2.0852130361073762d-01 ,
     &   8.0548337952222937d-01,-1.3988336846205129d+00 ,
     &   -3.7341808587443666d+00,-1.2548698951464416d+00 ,
     &   -6.2876428222134564d+00/

        data cy_geo2cgm/
     &   4.1482389675037042d-03,1.0678339688168021d+00 ,
     &   -2.5778851836895766d-02,-1.7600795803350611d-02 ,
     &   5.2919049458551637d-02,2.0824114104804892d-02 ,
     &   -1.2654429730684313d-02,-6.7475412623707598d-04 ,
     &   8.9074120920957789d-03,4.9266284664145711d-02 ,
     &   -2.3641997810454396d-02,-5.8921312663062109d-02 ,
     &   1.6687204999716254d-01,-2.4334574360937111d-02 ,
     &   -4.3568473599556512d-02,-2.7610979291672777d-02 ,
     &   -2.1747700122887181d-03,1.6013248176470540d-02 ,
     &   7.8975002757201707d-03,2.1092118626155454d-01 ,
     &   4.7264853369174187d-02,-7.0597381799345271d-02 ,
     &   -2.4932269454923528d-01,-9.8929937225875619d-02 ,
     &   1.5681694771558341d-02,-5.4047358521529532d-03 ,
     &   -7.9741058534921194d-02,-4.1178536602833327d-03 ,
     &   1.7851640495814536d-01,-4.5630969044952785d-02 ,
     &   -2.3522367086002305d-02,-2.5358317048379320d-02 ,
     &   2.2260418698488138d-01,-1.6772100894607433d-01 ,
     &   2.2904772288711683d-02,4.9312594700650436d-01 ,
     &   8.4632671893947187d-03,4.4711990931489254d-02 ,
     &   -4.9128813326395626d-02,-1.3545028678285576d-01 ,
     &   1.0920109337922668d-01,7.1753759875718970d-02 ,
     &   -3.7613843089889087d-01,1.0724718326127913d-01 ,
     &   2.7654036811486549d-01,-2.6946767229969470d-03 ,
     &   9.1817154679056046d-02,-1.7247046786081910d-02 ,
     &   2.2522447034134530d-02,-2.2912529393281034d-01 ,
     &   7.6974724982392217d-02,5.2854690659387416d-02 ,
     &   3.0124444388275151d-01,-6.7501134608392022d-02 ,
     &   2.2623692318526345d-03,1.5961749745834197d-02 ,
     &   1.8658562733264716d-03,-7.3395327253365394d-02 ,
     &   -4.5005979466196777d-01,2.9559288677955919d-01 ,
     &   7.3791392402517886d-01,6.2214947308893898d-01 ,
     &   -7.8520553339149046d-01,-4.6410400681051733d-04 ,
     &   2.8049885627524418d-02,-2.1956206915518806d-02 ,
     &   -6.8464684601167392d-02,1.6712815964865513d-01 ,
     &   1.3838818977092160d-01,-2.9255372003262892d-01 ,
     &   1.1333959748455982d+00,-1.3696614223689494d+00 ,
     &   7.5270894904488905d-04,1.1902533410648175d-03 ,
     &   -2.6463365493611946d-02,-1.9916296507290099d-02 ,
     &   3.6939815981395441d-01,-2.8674188676814083d-01 ,
     &   5.9050071000092430d-01,6.6268255940940435d-02 ,
     &   -3.5309083596412734d+00/

        data cx_cgm2geo/
     &   2.0217855012148990d-02,-8.6193284788734559d-02 ,
     &   -6.9743299263853031d-02,7.6137572567966938d-03 ,
     &   5.0224672262879411d-02,6.5971316057185092d-03 ,
     &   1.2462253251444011d-03,1.6624367355890790d-03 ,
     &   -2.2260569289924703d-03,1.1427152815028250d+00 ,
     &   2.6976298318331246d-02,-1.7850589437379538d-01 ,
     &   6.7311756750765284d-03,1.7698246304325238d-01 ,
     &   -9.7307938092875190d-02,1.0989892158281833d-03 ,
     &   9.8742296550611286d-03,-4.1480328204045236d-02 ,
     &   -6.2566876085904277d-02,2.2502483209401125d-01 ,
     &   1.9960114315285438d-01,-1.6128772387845203d-01 ,
     &   -9.3356123432101867d-02,-4.5418422162811112d-02 ,
     &   1.8323257940141957d-01,-2.1884013915382639d-02 ,
     &   -1.5058398633436809d-01,-2.6514110361581533d-01 ,
     &   1.9423550153756075d-02,5.0017046289427469d-01 ,
     &   -3.0909089008832780d-01,-1.1915714971180478d+00 ,
     &   1.3981835646472973d-01,6.4595128377823130d-01 ,
     &   -2.4021643786409186d-01,-4.1523529129335657d-01 ,
     &   3.1294530467270931d-02,-1.6068810338860740d-01 ,
     &   -1.4463337694495237d-01,4.1896604830435535d-01 ,
     &   1.2413731026117603d-01,-1.9391030717883950d-01 ,
     &   -2.6557920193226892d-02,-2.2930715448637784d-01 ,
     &   -5.5845961393060861d-02,8.7727476489508405d-02 ,
     &   -3.1458238715899256d-02,-4.6274533594589684d-01 ,
     &   4.5418258836812697d-01,1.7352303296356695d+00 ,
     &   -1.2285471123577736d+00,-1.3667215468485665d+00 ,
     &   -3.0698406138617429d-01,1.9984579223382752d+00 ,
     &   -5.4028761375519707d-03,6.7366399498403950d-02 ,
     &   -8.7778742533146215d-02,-1.1003896355748566d-01 ,
     &   5.2287100416924659d-01,1.6639080719323829d-01 ,
     &   -1.0696788722962083d+00,-2.5536378632386914d-01 ,
     &   4.6599232855696755d+00,-2.0215495722396781d-02 ,
     &   1.6834484525844573d-02,2.6243614644067748d-01 ,
     &   -4.0122290981628339d-01,-1.4638392527922406d+00 ,
     &   1.4089575172038167d+00,-4.1372568583028624d-02 ,
     &   2.9020768448754097d+00,-5.4252297779294167d-01 ,
     &   -2.9228624567458894d-03,-5.0765396548513309d-03 ,
     &   1.4307314204097565d-01,-1.9679209023979638d-01 ,
     &   -1.1938613513912060d+00,9.1417159599586739d-01 ,
     &   7.1327324622689048d-01,5.8478421355703176d+00 ,
     &   -4.0402396606787079d+00/

        data cy_cgm2geo/
     &   -4.8216797246345474d-03,9.4059888753779974d-01 ,
     &   2.4265422337391040d-02,5.9913203560446604d-03 ,
     &   -3.4257335254629595d-02,-1.1454178850009100d-02 ,
     &   5.9546956076257374d-03,-3.7133854368320840d-04 ,
     &   -1.8620627858563221d-03,-5.3139646976179192d-02 ,
     &   1.1948721872332368d-02,1.0392308147217699d-01 ,
     &   -9.6428749675430581d-02,-2.1144013008683515d-02 ,
     &   -3.1762695139889274d-02,9.4724839506881153d-03 ,
     &   -5.5814407848089331d-03,1.6638954096535485d-02 ,
     &   -5.9065589057476914d-03,-2.7637655762675900d-01 ,
     &   -1.1803604991001748d-02,2.0920163706883699d-01 ,
     &   2.1284181180251949d-01,8.2798140601312298d-03 ,
     &   1.2822041950414587d-02,1.0261421313202845d-02 ,
     &   4.9990177985336004d-02,3.3800800206460813d-02 ,
     &   -2.2001335617848206d-01,-1.8465477087695348d-01 ,
     &   1.5983877091480281d-01,2.2102253173892450d-01 ,
     &   -2.4987902288830810d-01,5.5485075212118318d-02 ,
     &   -1.5247033797095355d-02,-3.1091447670291927d-01 ,
     &   2.7437185122363150d-03,1.6121215571190151d-01 ,
     &   -8.9822955039522867d-02,-2.3290299174706774d-01 ,
     &   -4.0814642585246474d-02,2.6657665592733792d-01 ,
     &   -4.1999669342658308d-02,-1.1285978309933853d-01 ,
     &   2.2829047383766010d-01,-1.3090893494589029d-02 ,
     &   1.2014482089603007d-01,1.2793910959783261d-01 ,
     &   -4.5490116286828197d-01,-5.8823724853397152d-02 ,
     &   6.0441877764060337d-01,2.6954587782165618d-01 ,
     &   -4.5065993497792078d-01,2.6353483282400703d-01 ,
     &   -3.7635011836028021d-03,-2.8474077124421626d-02 ,
     &   6.6425893859872076d-02,6.5026940573488901d-02 ,
     &   -5.0248469515281613d-02,-7.4221115755790379d-04 ,
     &   7.2665029676818449d-01,-2.9018101691144693d-01 ,
     &   -6.8921261449804661d-01,3.4589599613266131d-03 ,
     &   -4.6585030955242246d-02,-9.0160068224349743d-03 ,
     &   3.0380317265098711d-01,-3.1345311965014844d-01 ,
     &   -4.1277766256825998d-02,-6.0298506002982322d-01 ,
     &   -1.2485492492032790d-01,-2.6784570922427520d-01 ,
     &   1.2446852877543435d-03,-8.3971539629033032d-03 ,
     &   -4.6306910903695098d-03,1.8811243342315720d-01 ,
     &   -3.5245461280101154d-01,4.2305893125012517d-01 ,
     &   -2.3072229800309287d+00,1.0257990504942427d+00 ,
     &   -8.9571300047100522d-01/

!        dlon=292.d0


        dlatgeo=latgeo*deg2rad
        dlongeo=(longeo+lonref)*deg2rad

        ca=cos(lat*deg2rad)
        sa=sin(lat*deg2rad)
        cb=cos(lon*deg2rad)
        sb=sin(lon*deg2rad)

        omega(1,1)=ca*cb
        omega(2,1)=ca*sb
        omega(3,1)=-sa
        omega(1,2)=-sb
        omega(2,2)=cb
        omega(3,2)=0.
        omega(1,3)=cb*sa
        omega(2,3)=sa*sb
        omega(3,3)=ca

        ca=cos(dlatgeo)
        cb=cos(dlongeo)
        sb=sin(dlongeo)
        sa=sin(dlatgeo)

        coordgeo(1)=ca*cb
        coordgeo(2)=ca*sb
        coordgeo(3)=sa

        do i=1,3
          coordmag(i)=0.
          do j=1,3
            coordmag(i)=coordmag(i)+omega(i,j)*coordgeo(j)
          enddo
        enddo

        latmag=asin(coordmag(3))

        if (abs(latmag-90.).lt.1.e-4) then
          lonmag=0.
        else
          lonmag=atan2(coordmag(2),coordmag(1))
        endif

        x(0)=1.d0
        y(0)=1.d0
        x(1)=cos(lonmag)*cos(latmag)
        y(1)=sin(lonmag)*cos(latmag)

        do i=2,ndeg
        x(i)=x(i-1)*x(1)
        enddo
        do j=2,mdeg
        y(j)=y(j-1)*y(1)
        enddo

        xm=0.
        ym=0.
        do i=0,ndeg
          do j=0,ndeg
            xm=xm+cx_geo2cgm(j,i)*x(i)*y(j)
            ym=ym+cy_geo2cgm(j,i)*x(i)*y(j)
          enddo
        enddo

        latmag=acos(sqrt(xm*xm+ym*ym))*rad2deg
        if(ym*xm.ne.0.) then
          lonmag=atan2(ym,xm)*rad2deg
          lonmag=mod(lonmag+360.d0,360.d0)
        else
          lonmag=lonref
        endif


        return

        entry mag2geo(latmag,lonmag,latgeo,longeo)

        dlatmag=latmag*deg2rad
        dlonmag=lonmag*deg2rad

        x(0)=1.
        y(0)=1.
        x(1)=cos(dlonmag)*cos(dlatmag)
        y(1)=sin(dlonmag)*cos(dlatmag)

        do i=2,ndeg
        x(i)=x(i-1)*x(1)
        enddo
        do j=2,mdeg
        y(j)=y(j-1)*y(1)
        enddo

        xm=0.
        ym=0.
        do i=0,ndeg
          do j=0,ndeg
            xm=xm+cx_cgm2geo(j,i)*x(i)*y(j)
            ym=ym+cy_cgm2geo(j,i)*x(i)*y(j)
          enddo
        enddo

        ca=sqrt(xm*xm+ym*ym)
        sa=sqrt(1-ca*ca)
        if(ym*xm.ne.0.) then
          dlonmag=atan2(ym,xm)
        else
          dlonmag=lonref
        endif

        cb=cos(dlonmag)
        sb=sin(dlonmag)

        coordmag(1)=ca*cb
        coordmag(2)=ca*sb
        coordmag(3)=sa


        do i=1,3
          coordgeo(i)=0.
          do j=1,3
            coordgeo(i)=coordgeo(i)+omega(j,i)*coordmag(j)
          enddo
        enddo

        latgeo=asin(coordgeo(3))*rad2deg

        if (abs(latgeo-90).lt.1.e-4) then
          longeo=0.
        else
          longeo=atan2(coordgeo(2),coordgeo(1))
        endif

        longeo=longeo*rad2deg

        longeo=mod(longeo-lonref+360.d0,360.d0)

        end subroutine geo2mag
